apiVersion: batch/v1
kind: CronJob
metadata:
  name: formula-tgx-spider
  namespace: mediafusion
  labels:
    app.kubernetes.io/name: tenant-cleaner  
spec:
  schedule: "0 */6 * * *" # run hourly
  concurrencyPolicy: Forbid # no more than one instance
  startingDeadlineSeconds: 60
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: formula-tgx-spider
        spec:
          restartPolicy: Never
          containers:
          - name: "formula-tgx-spider"
            command: ["pipenv", "run", "scrapy", "crawl", "formula_tgx"]
            image: ghcr.io/geek-cookbook/mediafusion:3.7.1@sha256:e714ab4f99519237cd10e9bb0b610d179edc87b4b0339f1bb0fd38769204e29a
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              privileged: false
              seccompProfile:
                type: RuntimeDefault   
              runAsNonRoot: true
              runAsUser: 568
              runAsGroup: 568
              capabilities:
                drop:
                - ALL              
            envFrom:
            - secretRef:
                name: mediafusion-env 
            - configMapRef:
                name: mediafusion-env          
            volumeMounts:
            - mountPath: /.local
              name: local
            - mountPath: /tmp
              name: tmp
          volumes:
          - ephemeral:
              volumeClaimTemplate:
                metadata:
                  creationTimestamp: null
                spec:
                  accessModes:
                  - ReadWriteOnce
                  resources:
                    requests:
                      storage: 1Gi
                  storageClassName: topolvm-provisioner-thin
                  volumeMode: Filesystem
            name: local
          - ephemeral:
              volumeClaimTemplate:
                metadata:
                  creationTimestamp: null
                spec:
                  accessModes:
                  - ReadWriteOnce
                  resources:
                    requests:
                      storage: 1Gi
                  storageClassName: topolvm-provisioner-thin
                  volumeMode: Filesystem
            name: tmp