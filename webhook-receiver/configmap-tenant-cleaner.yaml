apiVersion: v1
kind: ConfigMap
metadata:
  name: tenant-cleaner
  namespace: webhook-receiver
data:
  tenant-cleaner.sh: |
    #!/bin/bash

    # setup git
    git config --global user.name "Elfbot"
    git config --global user.email "elfbot@elfhosted.com"
    git config --global pull.rebase true

    set -x
    # set -e

    gh auth setup-git

    TEMPDIR=$(mktemp -d)
    cd $TEMPDIR
    gh repo clone elfhosted/tenants -- --depth=1
    git config --global --add safe.directory tenants
    cd tenants/fsn/

    BRANCH_NAME="tenant-cleaner"
    BASE_BRANCH="main"

    # Fetch and prepare branches
    git fetch origin
    git checkout "$BASE_BRANCH"
    git pull origin "$BASE_BRANCH"

    if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
      git checkout "$BRANCH_NAME"
      git pull origin "$BRANCH_NAME"
      git merge "$BASE_BRANCH"
    else
      git checkout -b "$BRANCH_NAME"
    fi

    ../scripts/process-all-customers.sh

    # clean out unused namespaces / kustomizations
    for TENANT in $(ls bootstrap/namespaces/namespace-*.yaml | cut -f2 -d- | cut -f1 -d.); do
      # Avoid null tenants
      if [[ ! "$TENANT" == "" ]]; then
        PVCs=$(kubectl get pvc -n aa-$TENANT)
        if [[ "$PVCs" == "" ]]; then
          # it's empty, we can delete it
          rm bootstrap/namespaces/namespace-$TENANT.yaml
          rm bootstrap/kustomizations/kustomization-$TENANT.yaml
          rm -rf tenants/$TENANT
        fi
      fi
    done
    
    DATE=$(date +"%Y-%m-%d")

    # Check if branch has diverged from base
    git fetch origin "$BASE_BRANCH"
    if git diff --quiet "origin/$BASE_BRANCH" "$BRANCH_NAME"; then
      echo "No changes to commit or push."
      exit 0
    fi

    # Stage and commit
    git add .
    if ! git diff --cached --quiet; then
      git commit -m "Tenant Cleaner cleans tenants on $DATE"
    fi

    # Push the branch (creates it remotely if needed)
    git push -u origin "$BRANCH_NAME"

    # Check if PR already exists
    existing_pr=$(gh pr list --head "$BRANCH_NAME" --base "$BASE_BRANCH" --state open --json number --jq '.[0].number')

    if [ -n "$existing_pr" ]; then
      echo "Pull request #$existing_pr already exists."
      sleep 1h
    else
      gh pr create --title "Tenant Cleaner" --body "Tenant Cleaner" --base "$BASE_BRANCH" --head "$BRANCH_NAME" --assignee funkypenguin
    fi
