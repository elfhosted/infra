apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: flaresolverr
  namespace: torrentio
spec:
  chart:
    spec:
      chart: flaresolverr
      version: 5.4.x
      sourceRef:
        kind: HelmRepository
        name: elfhosted
        namespace: flux-system
  interval: 15m
  timeout: 5m
  releaseName: flaresolverr
  values:
    image:
      registry: ghcr.io
      repository: flaresolverr/flaresolverr
      tag: v3.3.13
    securityContext:
      seccompProfile:
        type: RuntimeDefault
      # readOnlyRootFilesystem: 
    podSecurityContext:
      seccompProfile:
        type: RuntimeDefault
      # runAsUser: 10001
      # runAsGroup: 10001
    automountServiceAccountToken: false
    replicas: 2
    tolerations:
    - key: node-role.elfhosted.com/storage
      operator: Exists        
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: node-role.elfhosted.com/storage
              operator: Exists  
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution: 
        - weight: 100  
          podAffinityTerm:    
            labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - flaresolverr
            topologyKey: "kubernetes.io/hostname"  
    persistence:
      tmp:
        enabled: true
        mountPath: /tmp
        type: emptyDir
        sizeLimit: 1Gi                   
    resources:
      requests:
        cpu: 10m
        memory: 128Mi
      limits:
        memory: 4Gi

    additionalContainers:
      create-session:
        image: ghcr.io/geek-cookbook/tooling:focal-20231211@sha256:dc2f0486426c126331240a32e9a88357b284fedd3b40236dc13f7a1877115da1
        command:
        - /usr/bin/dumb-init
        - /bin/bash
        - -c
        - |
          
          # Create a persistent session in flaresolverr to make it faster
          curl -L -X POST 'http://localhost:8191/v1' -H 'Content-Type: application/json' --data-raw '{
            "cmd": "sessions.create",
            "session":"leetx"
          }'

          sleep infinity