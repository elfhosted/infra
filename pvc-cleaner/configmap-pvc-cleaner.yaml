apiVersion: v1
kind: ConfigMap
metadata:
  name: pvc-cleaner
  namespace: pvc-cleaner
data:
  pvc-cleaner.sh: |
    #!/bin/bash

    # Debug logs
    set -x

    set -o pipefail

    # Set timestamp
    TIMESTAMP_NOW=$(date +%s)

    NAMESPACES=$(kubectl get ns --no-headers=true | grep aa | cut -f1 -d" ")
    for NS in ${NAMESPACES}
    do

      # Get a list of all customer PVCs starting with config-
      PVCS=$(kubectl get pvc -n $NS --no-headers=true | cut -f1 -d' ')
            
      for PVC in ${PVCS}
      do
        # Is PVC currently bound

        if (kubectl describe pvc -n ${NS} ${PVC} | grep -q 'Used By:       <none>'); then

          kubectl label pvc -n $NS $PVC elfhosted.com/currently-unbound=true --overwrite
              
          # if not, then does the PVC already have a timestamp?
          if (kubectl describe pvc -n $NS $PVC | grep -q elfhosted.com/unused-since); then

            # if yes, and it's older than 31 days, then label for deletion
            TIMESTAMP_PVC=$(kubectl describe pvc -n $NS $PVC | grep elfhosted.com/unused-since | awk '{split($0,a); print a[3]}')
            TIMESTAMP_DIFF=$((TIMESTAMP_NOW-TIMESTAMP_PVC))
            if [[ $TIMESTAMP_DIFF -gt 276480 ]]; then # 276480 sec = 3.2 days

              echo "PVC $PVC in namespace $NS has been unused for > 31 days, flagging for removal it.."
              kubectl label pvc -n $NS $PVC elfhosted.com/unbound-and-older-than-32d=true --overwrite

              #echo kubectl delete pvc -n $NS $PVC
            else
              echo "Found annotated, unused PVC $PVC in NS $NS, but it's less than 3d old, so ignoring"
            fi
          else
            # label for cleanup in 3 days
            echo "Found unused PVC $PVC in NS $NS, recording when it first became unused"
            kubectl annotate pvc -n $NS $PVC elfhosted.com/unused-since=$TIMESTAMP_NOW
          fi
        else
          # the volume is mounted, so if there _was_ a label/annotation on the PVC, remove it
          if (kubectl describe pvc -n $NS $PVC | grep -q elfhosted.com/unused-since); then
            kubectl annotate pvc -n $NS $PVC elfhosted.com/unused-since- --overwrite
            kubectl label pvc -n $NS $PVC elfhosted.com/currently-unbound- --overwrite
          fi
        fi
      done
    done    
    