---
# tasks file for k3s-master

# update  
- name: install k3s on master[0]
  shell: >
    curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server \
      --flannel-backend=none  \
      --disable-network-policy \
      --disable-kube-proxy \
      --disable traefik \
      --disable servicelb \
      --flannel-iface={{ cluster_nic }} \
      --kube-controller-manager-arg=node-cidr-mask-size=22 \
      --kubelet-arg=max-pods=500 \
      --node-taint node-role.kubernetes.io/control-plane=true:NoSchedule \
      --prefer-bundled-bin \
      --cluster-init" \
    sh -

- name: get node token
  command: cat /var/lib/rancher/k3s/server/node-token
  register: node_token_result
  become: yes
  delegate_to: "{{ groups['k3s_servers'][0] }}"

- set_fact:
    node_token: "{{ node_token_result.stdout }}"
#    master_ip: "{{ hostvars[groups['k3s_servers'][0]].ansible_host }}"
    master_ip: "{{ cluster_nic_class_c }}.{{ hostvars[groups['k3s_servers'][0]].ansible_host.split('.')[3] }}"

- name: install k3s on master[1-n]
  shell: >
    curl -sfL https://get.k3s.io | 
    K3S_URL=https://{{ master_ip }}:6443 
    K3S_TOKEN={{ node_token }}
    INSTALL_K3S_EXEC="server \
      --flannel-iface={{ cluster_nic }} \
      --flannel-backend=none  \
      --disable-network-policy \
      --disable-kube-proxy \
      --disable traefik \
      --disable servicelb \
      --kube-controller-manager-arg=node-cidr-mask-size=22 \
      --kubelet-arg=max-pods=500 \
      --node-taint node-role.kubernetes.io/control-plane=true:NoSchedule \
      --prefer-bundled-bin" \
    sh -
  # args:
  #   creates: /usr/local/bin/k3s
  when: "groups['k3s_servers'][0] != inventory_hostname"

- name: setup kubectl auto-completion
  lineinfile:
    path: /root/.bash_profile
    regexp: 'source <\(kubectl completion bash\)'
    line: source <(kubectl completion bash)
    create: yes
