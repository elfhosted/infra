- name: Install dependencies
  apt:
    name:
      - build-essential
      - dkms
      - linux-headers-{{ ansible_kernel }}
      - wget
    state: present
  when: ansible_os_family == "Debian"

- name: Set driver filename
  set_fact:
    nvidia_driver_filename: "NVIDIA-Linux-x86_64-{{ packages.nvidia_driver.version }}.run"

- name: Download NVIDIA driver installer
  get_url:
    url: "https://us.download.nvidia.com/XFree86/Linux-x86_64/{{ packages.nvidia_driver.version }}/{{ nvidia_driver_filename }}"
    dest: "/tmp/{{ nvidia_driver_filename }}"
    mode: "0755"
    force: no  # prevent re-downloading if already exists

- name: Run NVIDIA driver installer
  command: >
    {{ nvidia_driver_local_path }} --silent --dkms
  args:
    creates: /usr/bin/nvidia-smi

- name: Enable DRM/KMS (modeset=1)
  copy:
    dest: /etc/modprobe.d/nvidia-drm.conf
    content: |
      options nvidia-drm modeset=1
    mode: '0644'

- name: Create systemd override to load nvidia modules
  copy:
    dest: /etc/modules-load.d/nvidia.conf
    content: |
      nvidia
      nvidia_uvm
      nvidia_drm
    mode: '0644'

- name: Load nvidia modules with DRM
  shell: |
    modprobe -r nvidia_drm || true
    modprobe nvidia_drm modeset=1
  args:
    warn: false

- name: Ensure nvidia-smi binary is present
  stat:
    path: /usr/bin/nvidia-smi
  register: nvidia_smi_check

- name: Run nvidia-smi to validate installation
  command: nvidia-smi
  register: nvidia_smi_output
  failed_when: nvidia_smi_output.rc != 0
  when: nvidia_smi_check.stat.exists

- name: Display nvidia-smi output
  debug:
    var: nvidia_smi_output.stdout_lines
  when: nvidia_smi_check.stat.exists

- name: Assert that nvidia-smi succeeded
  assert:
    that:
      - nvidia_smi_output.rc == 0
    fail_msg: "nvidia-smi failed â€” check driver installation or reboot"
    success_msg: "nvidia-smi succeeded and driver appears functional"


# - name: Reboot if required (to ensure /dev/dri is available)
#   reboot:
#     msg: "Rebooting to finalize NVIDIA DRM setup"
#     reboot_timeout: 600